---
import RecipeLayout from '../layouts/RecipeLayout.astro'

let error = ''

if (Astro.request.method === 'POST') {
  try {
    const data = await Astro.request.formData()
    const password = data.get('password')
    const name = data.get('name')?.toString().trim()

    // Access environment variable.
    // In dev with platformProxy, it's in Astro.locals.runtime.env
    // In prod, it's also in Astro.locals.runtime.env
    // We fallback to import.meta.env for safety if runtime is missing (though it shouldn't be)
    const env = Astro.locals.runtime?.env || import.meta.env
    const sitePassword = env.SITE_PASSWORD

    if (password === sitePassword) {
      if (!name) {
        error = 'Please enter your name'
      } else {
        const cookieOptions = {
          path: '/',
          httpOnly: true,
          secure: import.meta.env.PROD,
          maxAge: 60 * 60 * 24 * 30, // 30 days
        }

        // Auth token
        Astro.cookies.set('site_auth', 'true', cookieOptions)

        // User identity (not httpOnly so client can read "Welcome, Name")
        Astro.cookies.set('site_user', name, {
          ...cookieOptions,
          httpOnly: false,
        })

        return Astro.redirect('/protected/recipes')
      }
    } else {
      error = 'Incorrect password'
    }
  } catch (e) {
    console.error(e)
    error = 'Something went wrong'
  }
}
---

<RecipeLayout title="Login">
  <div class="flex flex-1 items-center justify-center p-4">
    <div class="w-full max-w-md border-4 border-black bg-white p-8 shadow-hard">
      <h1 class="mb-6 text-4xl font-black uppercase tracking-tighter">Chef Login</h1>

      {
        error && (
          <div class="mb-6 border-2 border-black bg-red-100 p-3 font-bold text-red-600">
            {error}
          </div>
        )
      }

      <form method="POST" class="flex flex-col gap-6">
        <label class="flex flex-col gap-2">
          <span class="text-sm font-black uppercase">Your Name</span>
          <input
            type="text"
            name="name"
            placeholder="e.g. Emilio"
            class="focus:bg-mustard border-4 border-black p-3 font-bold focus:outline-none"
            required
          />
        </label>

        <label class="flex flex-col gap-2">
          <span class="text-sm font-black uppercase">Password</span>
          <input
            type="password"
            name="password"
            placeholder="Enter password"
            class="focus:bg-mustard border-4 border-black p-3 font-bold focus:outline-none"
            required
          />
        </label>

        <button
          type="submit"
          class="bg-mustard border-4 border-black p-4 text-xl font-black uppercase shadow-hard transition-all hover:-translate-x-1 hover:-translate-y-1 hover:shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] active:translate-x-0 active:translate-y-0 active:shadow-none"
        >
          Enter Kitchen
        </button>
      </form>
    </div>
  </div>
</RecipeLayout>
