---
import RecipeLayout from '../layouts/RecipeLayout.astro'
import RecipeManagerClient from '../components/recipe-manager/RecipeManager'
import { db } from '../lib/firebase-server'
import { getEmailList } from '../lib/env'

const userId = Astro.cookies.get('site_user')?.value
let displayName = userId
let isAdmin = false
let hasOnboarded = false

if (userId) {
  const isTestMode = import.meta.env.PUBLIC_TEST_MODE === 'true'

  // BYPASS: In Test Mode, trust the TestUser completely to avoid "Split Brain" issues
  // between Client Mocks (MSW) and Server Real DB (Firestore)
  if (isTestMode && (userId === 'TestUser' || userId === 'test_user')) {
    hasOnboarded = true
    isAdmin = true
  } else {
    try {
      const userDoc = await db.getDocument('users', userId)
      if (userDoc) {
        if (typeof userDoc.displayName === 'string') {
          displayName = userDoc.displayName
        }
        if (typeof userDoc.email === 'string') {
          const adminEmails = getEmailList(Astro, 'ADMIN_EMAILS')
          if (adminEmails.includes(userDoc.email.toLowerCase())) {
            isAdmin = true
          }
        }
        if (typeof userDoc.hasOnboarded === 'boolean') {
          hasOnboarded = userDoc.hasOnboarded
        } else {
          hasOnboarded = true
        }
      }
    } catch (e) {
      // Ignore errors
    }
  }
}
---

<RecipeLayout title="My Recipes" isAdmin={isAdmin}>
  <RecipeManagerClient
    client:only="react"
    user={userId}
    isAdmin={isAdmin}
    hasOnboarded={hasOnboarded}
  />
</RecipeLayout>
