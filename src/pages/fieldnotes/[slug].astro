---
import Layout from '../../layouts/Layout.astro';
import BlogPostContent from '../../components/features/blog/BlogPostContent';
import { getEntry } from 'astro:content';

const { slug } = Astro.params;
if (!slug) return Astro.redirect('/404');

const post = await getEntry('posts', slug);
if (!post) return Astro.redirect('/404');

// In production, prevent access to drafts and future scheduled posts
if (import.meta.env.PROD) {
    if (post.data.status === 'draft') return Astro.redirect('/404');
    if (post.data.status === 'scheduled') {
        const publishDate = post.data.publishedDate || new Date(post.data.date);
        if (publishDate > new Date()) return Astro.redirect('/404');
    }
}

const { Content } = await post.render();

const categoryEntry = post.data.category ? await getEntry('categories', post.data.category) : null;
const categoryLabel = categoryEntry?.data.name || post.data.category;

const tagsWithLabels = post.data.tags ? await Promise.all(post.data.tags.map(async (tag) => {
    const entry = await getEntry('tags', tag);
    return {
        slug: tag,
        label: entry?.data.name || tag
    };
})) : [];
---

<Layout title={`${post.data.title} | Field Notes`}>
    <BlogPostContent 
        client:visible 
        post={post} 
        categoryLabel={categoryLabel}
        tagsWithLabels={tagsWithLabels}
    >
        <Content />
    </BlogPostContent>
</Layout>
